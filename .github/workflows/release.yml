name: "Automated Versioning & Release"

on:
  push:
    branches:
      - main  # `main` ë¸Œëžœì¹˜ì— push ë  ë•Œ ì‹¤í–‰
      - develop

permissions:
  contents: write   # âœ… GitHub Releases ìƒì„±/ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v3

      - name: "ðŸ” Load Previous Version & Generate New Version"
        run: |
          DATE=$(date +'%Y.%m.%d')  # í˜„ìž¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY.MM.DD)
          PREV_VERSION=$(cat version.txt 2>/dev/null || echo "$DATE.0")  # ê¸°ì¡´ ë²„ì „ ë¶ˆëŸ¬ì˜¤ê¸°
          PREV_DATE=$(echo $PREV_VERSION | cut -d. -f1-3)  # ê¸°ì¡´ ë²„ì „ì˜ ë‚ ì§œ ë¶€ë¶„ ì¶”ì¶œ
          PREV_BUILD=$(echo $PREV_VERSION | cut -d. -f4)  # ê¸°ì¡´ ë²„ì „ì˜ ë¹Œë“œ ìˆ«ìž ì¶”ì¶œ

          if [ "$PREV_DATE" == "$DATE" ]; then
            NEW_BUILD=$((PREV_BUILD + 1))  # ê°™ì€ ë‚ ì§œë©´ ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
          else
            NEW_BUILD=1  # ìƒˆë¡œìš´ ë‚ ì§œë©´ ë¹Œë“œ ë²ˆí˜¸ ì´ˆê¸°í™”
          fi

          NEW_VERSION="$DATE.$NEW_BUILD"
          echo $NEW_VERSION > version.txt
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: "ðŸ”„ Commit Updated Version"
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add version.txt
          git commit -m "ðŸ”„ Update version to ${{ env.NEW_VERSION }}"
          git push origin develop

      - name: "ðŸ· Create GitHub Tag"
        run: |
          git tag -a v${{ env.NEW_VERSION }} -m "Release version ${{ env.NEW_VERSION }}"
          git push origin v${{ env.NEW_VERSION }}

      - name: "ðŸ“œ Generate Release Notes"
        run: |
          echo "## Release Notes for v${{ env.NEW_VERSION }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ”¹ Recent Commits" >> release_notes.md
          git log --pretty=format:"- %h %s (%an)" -10 >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ”¹ Contributor Stats" >> release_notes.md
          git shortlog -sn >> release_notes.md


      - name: "ðŸš€ Publish GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: "Release v${{ env.NEW_VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
